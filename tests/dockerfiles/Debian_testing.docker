FROM debian:testing
MAINTAINER Piotr Krysik

RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
    cmake \
    autoconf \
    libtool \
    pkg-config \
    build-essential \
    libcppunit-dev \
    swig \
    doxygen \
    liblog4cpp5-dev \
    python3-docutils \
    python3-scipy \
    gnuradio-dev gnuradio libgmp-dev libboost-regex-dev \
    libosmocore-dev

# packages needed for gr-iqbal and gr-osmosdr
RUN apt-get install -y git libuhd-dev liborc-0.4-dev

COPY ./ /src/

RUN git clone --branch maint-3.8 --recurse-submodules https://github.com/velichkov/gr-iqbal && \
    cd gr-iqbal && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make -j $(nproc) install && \
    ldconfig

RUN git clone --branch maint-3.8 https://github.com/velichkov/gr-osmosdr && \
    cd gr-osmosdr && \
    mkdir build && \
    cd build && \
    cmake .. && \
    make -j $(nproc) install && \
    ldconfig

RUN mkdir /src/build
WORKDIR /src/build

RUN PYTHONPATH=/usr/local/lib/python3/dist-packages/:$PYTHONPATH cmake .. && \
    # The parallel build sometimes fails when the .grc_gnuradio
    # and .gnuradio directories do not exist
    mkdir $HOME/.grc_gnuradio/ $HOME/.gnuradio/ && \
    make -j $(nproc) && \
    make install && \
    ldconfig && \
    make CTEST_OUTPUT_ON_FAILURE=1 test
